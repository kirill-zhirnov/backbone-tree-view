!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","backbone-tree-model"],function(c,d){return a.BackTree=b(c,d)}):"object"==typeof exports?module.exports=b(require("underscore"),require("backbone"),require("backbone-tree-model")):a.BackTree=b(a._,a.Backbone)}(this,function(a,b){"use strict";var c,d=function(a,b){function c(){this.constructor=a}for(var d in b)e.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},e={}.hasOwnProperty;return c={plugins:{}},c.Model=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.defaults={open:!1},b.prototype.getTitle=function(){return this.get("title")},b.prototype.hasChildren=function(){return!!this.nodes()},b}(b.TreeModel),c.Collection=function(b){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,b),e.prototype.model=c.Model,e.prototype.getStates=function(b){var c;return null==b&&(b=["open","checked"]),c={},this.each(function(d){if(c[d.id]=a.pick(d.attributes,b),d.nodes())return a.extend(c,d.nodes().getStates(b))}),c},e.prototype.setStates=function(a){return this.each(function(b){if(a[b.id]&&b.set(a[b.id]),b.nodes())return b.nodes().setStates(a)})},e}(b.TreeCollection),c.Model.prototype.collectionConstructor=c.Collection,c.View=function(b){function e(b){a.extend(this,a.pick(b,["settings"])),this.settings instanceof c.Settings||(this.settings=new c.Settings(this.settings)),e.__super__.constructor.apply(this,arguments)}return d(e,b),e.prototype.remove=function(){return this.settings=null,this.model=null,this.collection=null,e.__super__.remove.apply(this,arguments)},e}(b.View),c.Tree=function(b){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,b),e.prototype.className="bt-bootstrap",e.prototype.initialize=function(){if(this.child=null,this.plugins=[],this.settings.set("$root",this.$el),a.isArray(this.collection)&&(this.collection=new c.Collection(this.collection)),!(this.collection&&this.collection instanceof c.Collection))throw new Error("You must specify @collection and it should be instance of BackTree.Collection.");return this.initPlugins()},e.prototype.initPlugins=function(){return a.each(this.settings.get("plugins"),function(b){return function(d,e){return b.plugins.push(new c.plugins[e](a.extend({collection:b.collection,settings:b.settings},d)))}}(this))},e.prototype.render=function(){return this.child=new c.List({collection:this.collection,settings:this.settings,className:"bt-root"}),this.$el.append(this.child.render().$el),this},e.prototype.remove=function(){return this.child&&this.child.remove(),this.child=null,a.each(this.plugins,function(a,b){return a.remove()}),this.plugins=[],this.settings.set("$root",null),e.__super__.remove.apply(this,arguments)},e}(c.View),c.Item=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.tagName="li",b.prototype.className="bt-item",b.prototype.initialize=function(){return this.childList=null,this.listenTo(this.model,"childrenChanged",this.onChildrenChanged),this.listenTo(this.model,"change:open",this.onOpenChanged),this.listenTo(this.model,"change:checked",this.onCheckedChanged),this.$el.data("view",this)},b.prototype.events=function(){return{"click > .wrapper .toggle":"onToggleClick","mousedown > .wrapper":"onMouseDown","touchstart > .wrapper":"onTouchStart",'click > .wrapper input[name="checkbox"]':"onCheckboxClicked",dragstart:function(a){return a.preventDefault()},"click > .wrapper .right-part .btn":"onUserButtonClicked"}},b.prototype.render=function(){return this.$el.html(this.getTpl()),this.model.hasChildren()&&this.model.get("open")&&(this.renderChildList(),this.childList.open(!1)),this.setupClassNames(),this},b.prototype.getTpl=function(){var a,b;return a="",this.settings.get("checkbox")&&(b=this.model.get("checked")?'checked="checked"':"",a='<input type="checkbox" name="checkbox" value="" '+b+" />"),'<div class="wrapper clearfix">\n\t<div class="left-part no-dnd">\n\t\t'+a+'\n\t\t<a class="toggle btn" href="#">\n\t\t\t<span></span>\n\t\t</a>\n\t</div>\n\t<div class="body-part">'+this.getBodyPart()+'</div>\n\t<div class="right-part no-dnd">'+this.getRightPart()+"</div>\n</div>"},b.prototype.getBodyPart=function(){return this.model.getTitle()},b.prototype.getRightPart=function(){return""},b.prototype.setupClassNames=function(){var a;return a=[],this.model.hasChildren()?(a.push("has-child"),this.model.get("open")&&a.push("open")):a.push("empty"),this.$el.addClass(a.join(" "))},b.prototype.resetClassNames=function(){return this.$el.removeClass("open empty has-child")},b.prototype.renderChildList=function(){return this.childList=new c.List({collection:this.model._nodes,settings:this.settings}),this.$el.append(this.childList.render().$el)},b.prototype.onToggleClick=function(a){if(a.preventDefault(),this.model.hasChildren())return this.model.set("open",!this.model.get("open"))},b.prototype.onOpenChanged=function(){return this.model.get("open")?(this.childList||this.renderChildList(),this.childList.open()):this.childList.close(),this.resetClassNames(),this.setupClassNames()},b.prototype.onChildrenChanged=function(){return this.resetClassNames(),this.setupClassNames()},b.prototype.onMouseDown=function(a){return this.model.root().trigger("dragStart",this,a)},b.prototype.onTouchStart=function(a){if(this.settings.get("touch"))return this.model.root().trigger("dragStart",this,a)},b.prototype.onCheckboxClicked=function(a){var b;return b=this.$el.find('input[name="checkbox"]'),this.model.set("checked",b.prop("checked")),this.model.root().trigger("checkboxChanged",a,this)},b.prototype.onCheckedChanged=function(){var a;return a=this.$el.find('input[name="checkbox"]'),a.prop("checked",this.model.get("checked"))},b.prototype.onUserButtonClicked=function(a){return this.model.root().trigger("userButtonClicked",a,this)},b.prototype.remove=function(){return this.$el.data("view",null),this.childList&&(this.childList.remove(),this.childList=null),b.__super__.remove.apply(this,arguments)},b}(c.View),c.List=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return d(c,b),c.prototype.tagName="ul",c.prototype.initialize=function(){return this.initItemsView(),this.listenTo(this.collection,"remove",this.onModelRemove),this.listenTo(this.collection,"add",this.onModelAdd),this.listenTo(this.collection,"reset",this.onCollectionReset)},c.prototype.initItemsView=function(){return this.children={},this.collection.forEach(function(a){return function(b){return a.children[b.cid]=a.settings.makeItem({model:b})}}(this))},c.prototype.render=function(){return a.each(this.children,function(a){return function(b){return a.$el.append(b.render().$el)}}(this)),this},c.prototype.open=function(a){return null==a&&(a=!0),a&&this.settings.get("animation")?this.$el.slideDown(200):this.$el.show()},c.prototype.close=function(a){return null==a&&(a=!0),a&&this.settings.get("animation")?this.$el.slideUp(200):this.$el.hide()},c.prototype.onModelRemove=function(a){return this.children[a.cid].remove(),delete this.children[a.cid]},c.prototype.onModelAdd=function(a){var b,c,d;if(d=this.collection.indexOf(a),c=this.settings.makeItem({model:a}),c.render(),0===d)this.$el.prepend(c.$el);else{if(b=this.$("> .bt-item:eq("+(d-1)+")"),!b.length)throw new Error("Previous el not found!");c.$el.insertAfter(b)}return this.children[a.cid]=c},c.prototype.onCollectionReset=function(){return a.each(this.children,function(a){return function(a,b){return a.remove()}}()),this.initItemsView(),this.render()},c.prototype.remove=function(){return a.each(this.children,function(a,b){return a.remove()}),this.children={},c.__super__.remove.apply(this,arguments)},c}(c.View),c.Placeholder=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return d(c,b),c.prototype.tagName="li",c.prototype.className="bt-item placeholder",c.prototype.initialize=function(b){return a.extend(this,a.pick(b,["replacedView"]))},c.prototype.placeholderToEl=function(){return this.$el.css({width:this.replacedView.$el.outerWidth()+"px",height:this.replacedView.$el.outerHeight()+"px"}),this.replace(this.replacedView.$el,this.$el)},c.prototype.elToPlaceholder=function(){return this.replace(this.$el,this.replacedView.$el)},c.prototype.replace=function(a,b){var c;return c=a.prev(),c.length>0?b.insertAfter(c):a.parent().prepend(b)},c.prototype.remove=function(){return this.replacedView=null,c.__super__.remove.apply(this,arguments)},c}(c.View),c.Settings=function(b){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,b),e.prototype.defaults={animation:!0,$root:null,plugins:[],dndSkipMove:[".btn",".no-dnd"],ItemConstructor:c.Item,ListConstructor:c.List,touch:!0,checkbox:!1},e.prototype.makeItem=function(b){return null==b&&(b={}),a.extend(b,{settings:this}),new(this.get("ItemConstructor"))(b)},e}(b.Model),c.plugins.Basic=function(){function b(b){a.extend(this,a.pick(b,["collection","settings"])),this.initialize.apply(this,arguments)}return b.prototype.initialize=function(){},b.prototype.remove=function(){return this.stopListening(),this.collection=null,this.settings=null,this},b}(),a.extend(c.plugins.Basic.prototype,b.Events),c.plugins.DnD=function(e){function f(){return f.__super__.constructor.apply(this,arguments)}return d(f,e),f.prototype.initialize=function(c){return this.view=null,this.lastMousePosition=null,this.movementDirection=null,this.$overlapped=null,this.placeHolder=null,this.shift={x:0,y:0},this.listenTo(this.collection,"dragStart",this.dragStart),b.$(document).on("mousemove.backTree",b.$.proxy(this.drag,this)),b.$(document).on("mouseup.backTree",b.$.proxy(this.dragEnd,this)),this.settings.get("touch")&&(b.$(document).on("touchmove.backTree",b.$.proxy(this.drag,this)),b.$(document).on("touchend.backTree touchcancel.backTree",b.$.proxy(this.dragEnd,this))),this.settings.get("$root").addClass("dnd"),a.extend(this,a.pick(c,["changeParent"])),a.defaults(this,{changeParent:!0})},f.prototype.dragStart=function(c,d){var e,f,g,h;if(e=b.$(d.target),g=!1,$.merge(e,e.parentsUntil(".bt-item")).each(function(c){return function(d,e){var f;return f=b.$(e),a.each(c.settings.get("dndSkipMove"),function(a){if(f.is(a))return g=!0})}}(this)),!g&&(d.preventDefault(),e.hasClass("bt-item")||(e=e.parents(".bt-item:eq(0)")),c.el===e.get(0)))return h=this.getXY(d),this.view=c,f=this.view.$el.offset(),this.shift.x=h.x-f.left,this.shift.y=h.y-f.top,this.createPlaceholder(),this.prepareDraggableEl(),this.lastMousePosition=null,this.moveAt(d)},f.prototype.dragEnd=function(a){if(this.view)return this.setOverlapped(null),this.removePlaceholder(),this.view.$el.removeClass("bt-is-dragged"),this.view.$el.css({left:"",top:"",display:"",width:"",height:""}),this.saveModelPosition(),this.view=null},f.prototype.drag=function(a){if(this.view)return this.moveAt(a),this.dragOver(a)},f.prototype.getXY=function(b){var c,d,e;return-1!==a.indexOf(["touchstart","touchmove"],b.type)&&(c=b.originalEvent.targetTouches[0])?(d=c.pageX,e=c.pageY):(d=b.pageX,e=b.pageY),{x:d,y:e}},f.prototype.dragOver=function(a){var b;if(b=this.getOverlap(a),this.setOverlapped(b.$el),this.$overlapped)return this.$overlapped.hasClass("placeholder")?this.dragOverPlaceholder(b):this.dragOverItem(b)},f.prototype.dragOverItem=function(a){var b,c;if(this.changeParent&&this.shallAddAsChild(this.$overlapped,a.coef))return this.addAsChild(this.$overlapped);if(this.changeParent&&(b=this.shallLevelUp(a.coef)))return this.placeHolder.$el.insertAfter(b);if("eq"!==this.movementDirection){if(!this.changeParent&&this.$overlapped.parent().get(0)!==this.placeHolder.$el.parent().get(0))return;return c=a.coef.vertical>50,"topLeft"!==a.direction&&"topRight"!==a.direction||(c=!c),c?this.placeHolder.$el.insertAfter(this.$overlapped):this.placeHolder.$el.insertBefore(this.$overlapped)}},f.prototype.dragOverPlaceholder=function(a){var b,c;if(this.changeParent){if(c=this.shallLevelUp(a.coef))return c.data("view"),void this.placeHolder.$el.insertAfter(c);b=this.shallLevelDown(a.coef),b&&this.addAsChild(b,"append")}},f.prototype.getOverlap=function(b){var c,d,e,f,g,h,i;return g=this.view.$el.offset(),i=this.view.$el.outerWidth(),e=this.view.$el.outerHeight(),c=[[g.left,g.top],[g.left+i,g.top+e]],h={topLeft:[g.left,g.top],topRight:[g.left+i,g.top],bottomLeft:[g.left,g.top+e],bottomRight:[g.left+i,g.top+e]},this.view.$el.hide(),d={},a.each(h,function(a,b){var c,e;return c=a[0]-$(window).scrollLeft(),e=a[1]-$(window).scrollTop(),d[b]=document.elementFromPoint(c,e)}),this.view.$el.show(),f={coef:0,key:null},a.each(d,function(a){return function(b,e){var g;if(g=a.getOverlappedEl(b))return d[e]={$el:g,coef:a.calcOverlapCoefficient(g,h[e],e,c)},d[e].coef.overlap>f.coef?(f.coef=d[e].coef.overlap,f.key=e):void 0}}(this)),f.key?{$el:d[f.key].$el,point:h[f.key],direction:f.key,coef:d[f.key].coef}:{$el:!1}},f.prototype.calcOverlapCoefficient=function(a,b,c,d){var e,f,g,h,i,j,k,l;return e=a.hasClass("placeholder")?a:a.find("> .wrapper"),g=e.offset(),j=e.outerWidth(),f=e.outerHeight(),i=[[g.left,g.top],[g.left+j,g.top+f]],h=d[0][0]-i[0][0],k=Math.max(0,Math.min(d[1][0],i[1][0])-Math.max(d[0][0],i[0][0])),l=Math.max(0,Math.min(d[1][1],i[1][1])-Math.max(d[0][1],i[0][1])),{vertical:Math.round(l/f*100),leftMargin:h,overlap:k*l}},f.prototype.getOverlappedEl=function(a){var c;return!!b.$.contains(this.settings.get("$root").get(0),a)&&(c=b.$(a),c.hasClass("placeholder")&&c.hasClass("bt-item")?c:(this.doesElHaveView(c)||(c=c.parents(".bt-item:eq(0)"),1===c.length&&this.doesElHaveView(c)||(c=!1)),c))},f.prototype.doesElHaveView=function(a){return!!(a.data("view")&&a.data("view")instanceof c.Item)},f.prototype.addAsChild=function(a,b){var c;return null==b&&(b="prepend"),c=a.data("view"),c.childList||(c.renderChildList(),c.childList.open(!1),a.data("view").model.set("open",!0)),c.childList.$el[b](this.placeHolder.$el)},f.prototype.shallLevelDown=function(a){var b,c;return b=this.$overlapped.prev(".bt-item:eq(0)"),!!(b.length&&this.doesElHaveView(b)&&a.leftMargin>30&&(c=b.data("view"),c.model.hasChildren()&&c.model.get("open")||!c.model.hasChildren()))&&(c.childList||(c.renderChildList(),c.childList.open(!1)),b)},f.prototype.shallLevelUp=function(a){var b,c;return!!(a.leftMargin<-30&&(c=this.$overlapped.parents(".bt-item:eq(0)"),c.length&&this.doesElHaveView(c)&&(b=c.find("> ul > .bt-item"),b.length>0&&b.index(this.$overlapped)===b.length-1)))&&c},f.prototype.shallAddAsChild=function(a,b){var c,d;if(d=a.data("view"),c=b.leftMargin>30){if(d.model.hasChildren()&&!d.model.get("open"))return d.model.set("open",!0),!1;d.childList||(d.renderChildList(),d.childList.open(!1))}return c},f.prototype.moveAt=function(a){var b,c,d;return d=this.getXY(a),b=d.x-this.shift.x,c=d.y-this.shift.y,this.view.$el.css({left:b+"px",top:c+"px"}),this.movementDirection=null,this.lastMousePosition&&(this.lastMousePosition.y>d.y?this.movementDirection="up":this.lastMousePosition.y<d.y?this.movementDirection="down":this.movementDirection="eq"),this.lastMousePosition=d},f.prototype.prepareDraggableEl=function(){return this.view.$el.css({width:this.view.$el.width()+"px",height:this.view.$el.height()+"px"}),b.$("body").append(this.view.$el),this.view.$el.addClass("bt-is-dragged")},f.prototype.createPlaceholder=function(){return this.placeHolder=new c.Placeholder({replacedView:this.view}),this.placeHolder.placeholderToEl()},f.prototype.removePlaceholder=function(){return this.placeHolder.elToPlaceholder(),this.placeHolder.remove()},f.prototype.setOverlapped=function(a){if(this.$overlapped&&this.$overlapped.removeClass("overlapped"),this.$overlapped=a,this.$overlapped)return this.$overlapped.addClass("overlapped")},f.prototype.saveModelPosition=function(){var a,b;if(a=this.view.model,b=this.setModelPosition(this.view.model,this.getModelPosition()))return this.collection.trigger("dndStructureChanged",a,b.oldPosition,b.newPosition)},f.prototype.setModelPosition=function(a,b){var c,d,e,f,g;return g={parent:a.parent(),index:this.getModelIndex(a)},e=g.parent?g.parent.cid:null,c=b.parent?b.parent.cid:null,(e!==c||g.index!==b.index)&&(f=a.collection,d=b.parent?b.parent._nodes:this.collection,f.remove(a),d.add(a,{at:b.index}),e===c?b.parent&&b.parent.trigger("childrenSorted",a,g,b):(g.parent&&g.parent.trigger("childrenChanged",a,g,b),b.parent&&(b.parent.trigger("childrenChanged",a,g,b),b.parent.set("open",!0))),{oldPosition:g,newPosition:b})},f.prototype.getModelPosition=function(){var a,b,c;return a=this.view.$el.parents(".bt-item:eq(0)"),a.length||(a=!1),c={parent:a?a.data("view").model:null,index:0},b=this.view.$el.parent().find("> .bt-item"),c.index=b.index(this.view.$el),c},f.prototype.getModelIndex=function(a){return a.collection.indexOf(a)},f.prototype.remove=function(){return this.view=null,this.$overlapped=null,this.placeHolder&&this.placeHolder.remove(),this.placeHolder=null,b.$(document).off("mousemove.backTree mouseup.backTree"),this.settings.get("touch")&&b.$(document).off("touchmove.backTree touchend.backTree touchcancel.backTree"),f.__super__.remove.apply(this,arguments)},f}(c.plugins.Basic),c});